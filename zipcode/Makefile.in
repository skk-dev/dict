# Makefile for ZIP-code dictionaries.

RM = @rm@
MKDIR = @mkdir@
GIT = @git@
WGET = @wget@
UNZIP = @unzip@
SKKDIC_EXPR2 = @skkdic_expr2@
SKKDIC_EXPR = @skkdic_expr@
SKKDIC_SORT = @skkdic_sort@
DENO = @deno@

srcdir = @srcdir@
top_srcdir = @top_srcdir@
temp_dir = @temp_dir@

TEMP_ZIPCODE=$(temp_dir)/.zipcode
TEMP_OFFICE=$(temp_dir)/.office
TEMP_GEO=$(temp_dir)/.geo

SOURCE_KEN_ALL=https://www.post.japanpost.jp/zipcode/dl/utf/zip/utf_ken_all.zip
SOURCE_JIGYOSYO=https://www.post.japanpost.jp/zipcode/dl/jigyosyo/zip/jigyosyo.zip

KEN_ALL_ZIP=$(temp_dir)/utf_ken_all.zip
JIGYOSYO_ZIP=$(temp_dir)/jigyosyo.zip

KEN_ALL=$(temp_dir)/utf_ken_all.csv
JIGYOSYO=$(temp_dir)/jigyosyo.csv

all: zipcode office

zipcode:
	$(DENO) run --allow-read --allow-write $(srcdir)/zipcode.ts \
	  --csv=$(KEN_ALL) --out=$(TEMP_ZIPCODE) \
	  --header=$(srcdir)/SKK-JISYO.zipcode \
	  --geo=$(TEMP_GEO) \
	  --words=$(srcdir)/words.zipcode
ifneq ($(SKKDIC_EXPR2),)
	$(SKKDIC_EXPR2) $(TEMP_ZIPCODE) >> $(srcdir)/SKK-JISYO.zipcode
else
	$(SKKDIC_EXPR) $(TEMP_ZIPCODE) \
	  | $(SKKDIC_SORT) >> $(srcdir)/SKK-JISYO.zipcode
endif

office:
	$(DENO) run --allow-read --allow-write $(srcdir)/zipcode.ts \
	  --csv=$(JIGYOSYO) --office=$(TEMP_OFFICE) \
	  --header=$(srcdir)/SKK-JISYO.office.zipcode \
	  --geo="" --words=""
ifneq ($(SKKDIC_EXPR2),)
	$(SKKDIC_EXPR2) $(TEMP_OFFICE) >> $(srcdir)/SKK-JISYO.office.zipcode
else
	$(SKKDIC_EXPR) $(TEMP_OFFICE) \
	  | $(SKKDIC_SORT) >> $(srcdir)/SKK-JISYO.office.zipcode
endif

# For checking new entries.

update: all diff

orig:
	-$(GIT) show HEAD:$(srcdir)/SKK-JISYO.office.zipcode \
	  > SKK-JISYO.office.zipcode.orig
	-$(GIT) show HEAD:$(srcdir)/SKK-JISYO.zipcode > SKK-JISYO.zipcode.orig
	-$(GIT) show HEAD:$(srcdir)/words.zipcode > words.zipcode.orig

diff:
	-$(GIT) diff $(srcdir)/SKK-JISYO.office.zipcode \
	  > SKK-JISYO.office.zipcode.diff
	-$(GIT) diff $(srcdir)/SKK-JISYO.zipcode \
	  > SKK-JISYO.zipcode.diff
	-$(GIT) diff $(srcdir)/words.zipcode \
	  > words.zipcode.diff

# For doing everything automatically.

batch-update: fetch extract update

batch: fetch extract all

fetch:
	$(MKDIR) -p $(temp_dir)
	-$(RM) -f $(KEN_ALL_ZIP) $(JIGYOSYO_ZIP)
	$(WGET) -O $(KEN_ALL_ZIP) $(SOURCE_KEN_ALL)
	$(WGET) -O $(JIGYOSYO_ZIP) $(SOURCE_JIGYOSYO)

extract:
	$(UNZIP) -p $(KEN_ALL_ZIP) > $(KEN_ALL)
	$(UNZIP) -p $(JIGYOSYO_ZIP) > $(JIGYOSYO)

clean:
	-$(RM) -f $(TEMP_ZIPCODE) $(TEMP_OFFICE)

clean-temps: clean
	-$(RM) -rf $(temp_dir)

clean-diffs:
	-$(RM) -f SKK-JISYO.office.zipcode.orig \
	  SKK-JISYO.office.zipcode.diff \
	  SKK-JISYO.zipcode.orig \
	  SKK-JISYO.zipcode.diff \
	  words.zipcode.orig \
	  words.zipcode.diff

mostlyclean: clean-temps clean-diffs
	-$(RM) -f config.status \
	  config.log \
	  $(srcdir)/test/zipcode-test.sh \
	  Makefile

distclean: mostlyclean
	-$(RM) -f $(srcdir)/SKK-JISYO.office.zipcode \
	  $(srcdir)/SKK-JISYO.zipcode \
	  $(srcdir)/words.zipcode

.PHONY: test
test:
	. $(srcdir)/test/zipcode-test.sh
